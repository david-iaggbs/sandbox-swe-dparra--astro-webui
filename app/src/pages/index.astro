---
import Layout from '../layouts/Layout.astro';
import { loadDescription } from '../lib/config';

const description = await loadDescription();
---

<Layout title="Greeting Service">
  <main>
    <section class="description-panel">
      <p>{description}</p>
    </section>

    <section class="main-panel">
      <nav class="tabs">
        <button class="tab active" data-tab="create">Create</button>
        <button class="tab" data-tab="lookup">Lookup</button>
        <button class="tab" data-tab="delete">Delete</button>
        <button class="tab" data-tab="list">List All</button>
      </nav>

      <div class="tab-content active" id="tab-create">
        <form id="create-form">
          <div class="form-row">
            <div class="field">
              <label for="create-name">NAME</label>
              <input id="create-name" name="name" type="text" placeholder="e.g. Morning" required />
            </div>
            <div class="field">
              <label for="create-suffix">MESSAGE</label>
              <input id="create-suffix" name="suffix" type="text" placeholder="e.g. Good morning!" required />
            </div>
            <div class="field field-btn">
              <button type="submit" class="btn-primary">Create</button>
            </div>
          </div>
        </form>
        <div id="create-result" class="result"></div>
      </div>

      <div class="tab-content" id="tab-lookup">
        <form id="lookup-form">
          <div class="form-row">
            <div class="field field-grow">
              <label for="lookup-id">GREETING ID</label>
              <input id="lookup-id" name="id" type="text" placeholder="Enter greeting UUID" required />
            </div>
            <div class="field field-btn">
              <button type="submit" class="btn-primary">Lookup</button>
            </div>
          </div>
        </form>
        <div id="lookup-result" class="result"></div>
      </div>

      <div class="tab-content" id="tab-delete">
        <form id="delete-form">
          <div class="form-row">
            <div class="field field-grow">
              <label for="delete-id">GREETING ID</label>
              <input id="delete-id" name="id" type="text" placeholder="Enter greeting UUID" required />
            </div>
            <div class="field field-btn">
              <button type="submit" class="btn-primary btn-danger">Delete</button>
            </div>
          </div>
        </form>
        <div id="delete-result" class="result"></div>
      </div>

      <div class="tab-content" id="tab-list">
        <div class="list-header">
          <button id="refresh-btn" class="btn-primary">Refresh List</button>
        </div>
        <div id="greetings-list" class="result">
          <p class="muted">Click "Refresh List" to load greetings.</p>
        </div>
      </div>
    </section>
  </main>
</Layout>

<script>
  function el(id: string) { return document.getElementById(id)!; }

  function showResult(targetId: string, html: string) {
    el(targetId).innerHTML = html;
  }

  function showError(targetId: string, msg: string) {
    showResult(targetId, `<p class="error">${msg}</p>`);
  }

  function greetingCard(g: any): string {
    return `<div class="card">
      <div class="card-row">
        <span class="card-name">${g.name}</span>
        <span class="card-id">${g.id}</span>
      </div>
      <div class="card-message">${g.fullMessage}</div>
      <div class="card-meta">Created: ${new Date(g.createdAt).toLocaleString()}</div>
    </div>`;
  }

  // Tab switching
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      el(`tab-${(tab as HTMLElement).dataset.tab}`).classList.add('active');
    });
  });

  // Create greeting
  el('create-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = (el('create-name') as HTMLInputElement).value;
    const suffix = (el('create-suffix') as HTMLInputElement).value;
    try {
      const res = await fetch('/api/greetings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, suffix }),
      });
      const data = await res.json();
      if (res.ok) {
        showResult('create-result', `<p class="success">Greeting created successfully.</p>${greetingCard(data)}`);
        (el('create-form') as HTMLFormElement).reset();
      } else {
        showError('create-result', data.message || `Error ${res.status}`);
      }
    } catch (err) {
      showError('create-result', 'Failed to connect to API backend.');
    }
  });

  // Lookup greeting
  el('lookup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = (el('lookup-id') as HTMLInputElement).value;
    try {
      const res = await fetch(`/api/greetings/${id}`);
      const data = await res.json();
      if (res.ok) {
        showResult('lookup-result', greetingCard(data));
      } else {
        showError('lookup-result', data.message || `Greeting not found (${res.status})`);
      }
    } catch (err) {
      showError('lookup-result', 'Failed to connect to API backend.');
    }
  });

  // Delete greeting
  el('delete-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = (el('delete-id') as HTMLInputElement).value;
    try {
      const res = await fetch(`/api/greetings/${id}`, { method: 'DELETE' });
      if (res.status === 204) {
        showResult('delete-result', '<p class="success">Greeting deleted.</p>');
        (el('delete-form') as HTMLFormElement).reset();
      } else {
        const data = await res.json();
        showError('delete-result', data.message || `Error ${res.status}`);
      }
    } catch (err) {
      showError('delete-result', 'Failed to connect to API backend.');
    }
  });

  // Refresh list
  async function loadGreetings() {
    try {
      const res = await fetch('/api/greetings');
      const data = await res.json();
      if (res.ok && Array.isArray(data) && data.length > 0) {
        showResult('greetings-list', data.map(greetingCard).join(''));
      } else if (res.ok) {
        showResult('greetings-list', '<p class="muted">No greetings stored yet.</p>');
      } else {
        showError('greetings-list', data.message || `Error ${res.status}`);
      }
    } catch (err) {
      showError('greetings-list', 'Failed to connect to API backend.');
    }
  }

  el('refresh-btn').addEventListener('click', loadGreetings);
</script>

<style>
  main {
    max-width: 780px;
    width: 100%;
    margin: 0 auto;
    padding: 2rem 1rem;
    flex: 1;
  }

  /* Description panel */
  .description-panel {
    background: var(--color-panel);
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 1.25rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .description-panel p {
    margin: 0;
    color: var(--color-muted);
    font-size: 0.92rem;
    line-height: 1.6;
  }

  /* Main panel */
  .main-panel {
    background: var(--color-panel);
    border-radius: 8px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  /* Tabs */
  .tabs {
    display: flex;
    border-bottom: 2px solid #e5e5e5;
    padding: 0;
  }

  .tab {
    flex: 1;
    padding: 0.9rem 1rem;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    font-size: 0.88rem;
    font-weight: 600;
    color: var(--color-muted);
    cursor: pointer;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    transition: color 0.2s, border-color 0.2s;
  }

  .tab:hover {
    color: var(--color-text);
  }

  .tab.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
  }

  /* Tab content */
  .tab-content {
    display: none;
    padding: 1.5rem;
  }

  .tab-content.active {
    display: block;
  }

  /* Form layout */
  .form-row {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
  }

  .field {
    flex: 1;
  }

  .field-grow {
    flex: 2;
  }

  .field-btn {
    flex: 0 0 auto;
  }

  .field label {
    display: block;
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--color-muted);
    letter-spacing: 0.06em;
    margin-bottom: 0.35rem;
  }

  input {
    width: 100%;
    padding: 0.6rem 0.85rem;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    font-size: 0.9rem;
    color: var(--color-text);
    background: #ffffff;
    transition: border-color 0.2s;
  }

  input::placeholder {
    color: #aaaaaa;
  }

  input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(213, 0, 50, 0.12);
  }

  /* Buttons */
  .btn-primary {
    padding: 0.6rem 1.75rem;
    background: var(--color-primary);
    color: #ffffff;
    border: none;
    border-radius: 4px;
    font-size: 0.88rem;
    font-weight: 600;
    cursor: pointer;
    letter-spacing: 0.02em;
    white-space: nowrap;
    transition: background 0.2s;
  }

  .btn-primary:hover {
    background: var(--color-primary-dark);
  }

  .btn-danger {
    background: #c62828;
  }

  .btn-danger:hover {
    background: #a31d1d;
  }

  /* List header */
  .list-header {
    margin-bottom: 1rem;
  }

  /* Results */
  .result {
    margin-top: 1rem;
  }

  /* Cards */
  .card {
    border: 1px solid #e8e8e8;
    border-radius: 6px;
    padding: 0.85rem 1rem;
    margin-bottom: 0.6rem;
    background: #fafafa;
  }

  .card-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.3rem;
  }

  .card-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--color-text);
  }

  .card-id {
    font-family: "SF Mono", Monaco, Consolas, monospace;
    font-size: 0.7rem;
    color: #999999;
  }

  .card-message {
    font-size: 0.9rem;
    color: var(--color-muted);
    margin-bottom: 0.25rem;
  }

  .card-meta {
    font-size: 0.75rem;
    color: #aaaaaa;
  }

  .success {
    color: var(--color-success);
    font-weight: 500;
  }

  .error {
    color: var(--color-error);
    font-weight: 500;
  }

  .muted {
    color: var(--color-muted);
    font-size: 0.9rem;
  }

  /* Responsive */
  @media (max-width: 600px) {
    .form-row {
      flex-direction: column;
      align-items: stretch;
    }

    .field-btn {
      flex: 1;
    }

    .btn-primary {
      width: 100%;
    }
  }
</style>
